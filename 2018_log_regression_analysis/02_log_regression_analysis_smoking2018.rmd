---
title: "Socioeconomic patterns in smoking cessation behavior"
date: "12/07/2020"
output: pdf_document
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, message = FALSE, echo = FALSE)
```

This markdown document serves as a manual for repeating this analysis.The code chunks are in darker boxes while the results are in lighter boxes just below code chunk. 

### Libraries Needed for Execution of Code
```{r, message = FALSE, warning = FALSE}
library(tidyverse) #data wrangling, analysis and visualization
library(gridExtra) #data visualization
library(survey) #library for working with survey data
library(knitr) #library for kniting code and documents into HMTL, PDF, slides e.t.c.
library(lubridate) #library for working with or coercing dates 
                    #(used in this document to track date of quit)
#library(broom)
# To install needed Libraries, please run the following code in R or Rstudio
#installed_pkgs <- row.names(installed.packages())
#pkgs <- c("tidverse", "gridExtra", "survey", "knitr", "lubridate")
#for(p in pkgs){
#if(!(p %in% installed_pkgs)){
#install.packages(p, repos = "http://cran.us.r-project.org")
#}
#}
```


### Cleaning data and Assigning Variables
The data set contains only people who are current and former smokers. Total observations, variables collected are reported below.

```{r}
nhis18_modelling <- read.csv("nhis18_modelling.csv")
#converting variables to factors
nhis18_modelling$REGION <- factor(nhis18_modelling$REGION)
nhis18_modelling$binned_age <- factor(nhis18_modelling$binned_age,
                                      levels = c("18-24", "25-44","45-64","65+"))
nhis18_modelling$SEX <- factor(nhis18_modelling$SEX)
nhis18_modelling$RACERPI2 <- factor(nhis18_modelling$RACERPI2, 
                                    levels = c("white","Black/African American", "AIAN", "Asian", "Multiple"))
nhis18_modelling$EDUC1 <- factor(nhis18_modelling$EDUC1,
                                 levels = c("<HS Grad", "HS Grad", "<College Grad", "College Grad+"))
nhis18_modelling$binned_RATCAT <- factor(nhis18_modelling$binned_RATCAT, 
                                         levels = c("<100%", "100 - 200 %", "200 - 400 %", ">400%"))
nhis18_modelling$ORIENT_A <- factor(nhis18_modelling$ORIENT_A, 
                                    levels = c("Straight", "Gay/Lesbian", "Bisexual", "Something else", "Don't know the answer"))
nhis18_modelling$mental_health_problem <- factor(nhis18_modelling$mental_health_problem,
                                                 levels = c("No","Yes"))
nhis18_modelling$HOUSEOWN <- factor(nhis18_modelling$HOUSEOWN)
nhis18_modelling$FOOD_SECURITY <- factor(nhis18_modelling$FOOD_SECURITY, 
                                         levels = c("very low", "low", "high"))
nhis18_modelling$INC_GRP <- factor(nhis18_modelling$INC_GRP, 
                                   levels = c("$0-34,999", "$35,000 - 74,999", "$75,000 - 99,999", "$100,000 and over"))
nhis18_modelling$DEPEV_A <- factor(nhis18_modelling$DEPEV_A,
                                   levels = c("No", "Yes"))
nhis18_modelling$ANXEV_A <- factor(nhis18_modelling$ANXEV_A,
                                   levels = c("No", "Yes"))
```

### Survey design using survey weights
```{r}

nhis18_design <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE,
                           weights = ~WTFA_SA, data = nhis18_modelling)
```

```{r}
str(nhis18_modelling)
```
The table above shows smoking quit types without weights. "1" means the individual is a current smoker, "2" means that the individual quit smoking for only less than 6 months, "3" means the individual quit smoking from between 6 to 11 months", "4" means that the individual quit smoking for over a year. This variable would be used to create smaller data sets for regression purposes. 

The second table applied weighting to the groups.

### Years people quit smoking
The table below shows the top 10 years that people in this data set quit smoking.
```{r}
top_quit_years <- nhis18_modelling %>%
  rename(`Year of Quit` = QUIT_SMOKING_YEAR) %>%
  group_by(`Year of Quit`)%>%
  summarize(Quits = n())%>%
  arrange(desc(Quits))%>%
  filter(!is.na(`Year of Quit`))
kable(head(top_quit_years, 10), caption="Top 10 years people quit smoking")
```

### Characteristics of study sample (smokers and quitters)
```{r, message = FALSE, echo = FALSE}

#freq_tablefunction <- function(my_data, var, label){
 #   my_data %>%
 #   filter(!is.na(my_data[var]))%>%
#    group_by(my_data[var])%>%
  #  summarize(Freq = n())%>%
 #   mutate(`%` = Freq/sum(Freq) * 100)
 #   kable(caption = label)
#}

#freq_table_function(nhis18_modelling, "EDUC1", "Education")

#freq_table_function(nhis18_modelling, "SEX", "Gender")

#freq_table_function(nhis18_modelling, "REGION", "Region")

#freq_table_function(nhis18_modelling, "binned_age", "By Age")

#freq_table_function(nhis18_modelling, "RACERPI2", "Race Group")

#freq_table_function(nhis18_modelling, "binned_RATCAT", "Ratio of Income to FPL")

#freq_table_function(nhis18_modelling, "ORIENT_A", "Sexual Orientation")

#freq_table_function(nhis18_modelling, "mental_health_problem", "Mental Health Conditions")

#freq_table_function(nhis18_modelling, "HOUSEOWN", "House Ownweship")

#freq_table_function(nhis18_modelling, "FOOD_SECURITY", "Food Security")
```


## Creating datasets for each types of quit 
### Data set for all quit and current smokers

```{r}
all_smoke_quit <- nhis18_modelling
all_smoke_quit$QUIT_STATUS <- ifelse(all_smoke_quit$QUIT_TYPE == 1, 0, 1)

#non_weighted totals
table(all_smoke_quit$QUIT_STATUS)
my_table = as.table(table(all_smoke_quit$QUIT_STATUS))
round(prop.table(my_table) * 100, 2)
```


### Data set for quit less than 6 months

```{r}
smoke_quit_less6months <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE ==1| nhis18_modelling$QUIT_TYPE == 2)

smoke_quit_less6months$QUIT_STATUS <- ifelse(smoke_quit_less6months$QUIT_TYPE == 1, 0, 1)

#creating survey design
less6months_design  <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE,
                           weights = ~WTFA_SA, data = smoke_quit_less6months)
#non_weighted totals
table(smoke_quit_less6months$QUIT_STATUS)
```


### Data set for quit between 6 and 11 months

```{r}
smoke_quit_6to11months <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE ==1| nhis18_modelling$QUIT_TYPE == 3)
smoke_quit_6to11months$QUIT_STATUS <- ifelse(smoke_quit_6to11months$QUIT_TYPE == 1, 0, 1)

#creating survey design
sixto11quit_design  <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE,
                           weights = ~WTFA_SA, data = smoke_quit_6to11months)
#non_weighted totals
table(smoke_quit_6to11months$QUIT_STATUS)
my_table = as.table(table(smoke_quit_6to11months$QUIT_STATUS))
round(prop.table(my_table) * 100, 2)

```

### data set for quit less than a year
```{r}
smoke_quit_lessthanyear <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE == 1|
                                    nhis18_modelling$QUIT_TYPE == 2|
                                    nhis18_modelling$QUIT_TYPE == 3)
smoke_quit_lessthanyear$QUIT_STATUS <- ifelse(smoke_quit_lessthanyear$QUIT_TYPE == 2|
                                                smoke_quit_lessthanyear$QUIT_TYPE == 3, 1, 0)

#creating survey design
lessthanyear_design <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE, 
                                 weights = ~WTFA_SA, data = smoke_quit_lessthanyear)
#non_weighted_totals
table(smoke_quit_lessthanyear$QUIT_STATUS)
my_table = as.table(table(smoke_quit_lessthanyear$QUIT_STATUS))
round(prop.table(my_table) * 100, 2)
```


### data set for quit at least 6 months
```{r}
quit_6month_and_over <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE == 1|
                                 nhis18_modelling$QUIT_TYPE == 3|
                                 nhis18_modelling$QUIT_TYPE == 4)
quit_6month_and_over$QUIT_STATUS <- ifelse(quit_6month_and_over$QUIT_TYPE == 1, 0, 1)

#creating survey design
quit_6month_and_over_design <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE,
                                         weights = ~WTFA_SA, 
                                         data = quit_6month_and_over)

#non_weighted totals
table(quit_6month_and_over$QUIT_STATUS)
my_table = as.table(table(quit_6month_and_over$QUIT_STATUS))
round(prop.table(my_table) * 100, 2)
```

### data set for quit at least a year
```{r}
smoke_quit_yearandover <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE ==1| nhis18_modelling$QUIT_TYPE == 4)

smoke_quit_yearandover$QUIT_STATUS <- ifelse(smoke_quit_yearandover$QUIT_TYPE == 1, 0, 1)

#creating survey design
yearandover_design <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE,
                           weights = ~WTFA_SA, data = smoke_quit_yearandover)
#non_weighted totals
table(smoke_quit_yearandover$QUIT_STATUS)
my_table = as.table(table(smoke_quit_yearandover$QUIT_STATUS))
round(prop.table(my_table) * 100, 2)
```



### data set for attempt to quit smoking
Note that the CIGQTYR variable records people that attempt to quit smoking within the last 12 months.
We are subsetting for only current smokers. 
```{r}
attempt_to_quit <- subset(nhis18_modelling, nhis18_modelling$QUIT_TYPE == 1)

#creating survey design
attempt_to_quit_design <- svydesign(id = ~PPSU, strata = ~PSTRAT, nest = TRUE, 
                                 weights = ~WTFA_SA, data = attempt_to_quit)
# non_weighted_totals
table(attempt_to_quit$CIGQTYR)
my_table = as.table(table(attempt_to_quit$CIGQTYR))
round(prop.table(my_table) * 100, 2)
```
## Regression Analysis


### Creating a function that calculates unadjusted and adjusted Quit rates
The function I defined below calculates un-adjusted rates using the original data and uses the regression results to predict the quit probability for each observation in the data set. The quit probability is summarized across different sub-populations and reported with the un-adjusted rate in a table as a percentage. 
```{r}
readjust_function <- function(dframe1, dframe2, a_var, label){
  dframe1$QUIT_STATUS <- as.character(dframe1$QUIT_STATUS)
  dframe1 <- dframe1 %>%
    select({{a_var}}, QUIT_STATUS)
  dframe1 <- na.omit(dframe1)
  unadjusted_quit <- dframe1%>%
    group_by({{a_var}}, QUIT_STATUS)%>%
    summarize(QUIT_RATE = n())%>%
    spread(QUIT_STATUS, QUIT_RATE)%>%
    transmute(`Unadjusted Quit Rate` = round((`1`)/(`1` + `0`) * 100, 1))

  adjusted_quit <- dframe2 %>%
    group_by({{a_var}})%>%
    summarize(`Adjusted Quit Rate` = round(mean(adjusted_quit_status) * 100, 1))%>%
    select(`Adjusted Quit Rate`)
  
  tabulate <- cbind(unadjusted_quit, adjusted_quit)
  kable(tabulate)
  
}
```

In the regression modeling, I did not account for possible interaction among the variables. The original coefficients results for are reported as log odd-ratio. I converted the log odd-ratio to odd ratio by taking the exponents. I also reported a 95 percent confidence interval for each of the odds ratio. I also reported the un-adjusted and adjusted quit rates using the function created earlier across different sub-populations.  
## Quit Smoking less than a Year
```{r}
# Quit smoke for less than a year
vars <- c("binned_age", "SEX", "EDUC1", "binned_RATCAT", "ORIENT_A", "mental_health_problem",
         "RACERPI2", "HOUSEOWN", "INC_GRP", "FOOD_SECURITY")

reg1_quit_lessthanyear <- smoke_quit_lessthanyear %>%
                          drop_na(REGION, any_of(vars))

reg1 <- svyglm(formula = QUIT_STATUS ~ REGION + binned_age + SEX + EDUC1 + binned_RATCAT
               + ORIENT_A + mental_health_problem + RACERPI2+ HOUSEOWN + INC_GRP + FOOD_SECURITY, 
               design = lessthanyear_design, 
               family = quasibinomial,
               data = smoke_quit_lessthanyear,
               na.action = na.omit)
summary(reg1)

# exponentiation of the coefficients to odds ratio with a 95 percent confidence interval
kable(exp(cbind(`Adjusted Odds Ratio` = coef(reg1), confint(reg1))), digits=3)

#fitting model to data
predicted_quit <- reg1_quit_lessthanyear %>%
  mutate(
    adjusted_quit_status = predict(
      reg1,
      reg1_quit_lessthanyear,
      type = "response"
    )
  )

#smoke_quit_lessthanyear$QUIT_STATUS <- as.character(smoke_quit_lessthanyear$QUIT_STATUS)
#unadjusted_quit <- smoke_quit_lessthanyear %>%
  #select(REGION, QUIT_STATUS)%>%
  #group_by(REGION, QUIT_STATUS)%>%
  #summarize(QUIT_RATE = n())%>%
  #spread(QUIT_STATUS, QUIT_RATE)%>%
  #transmute(`Unadjusted Quit Rate` = round((`1`)/(`1` + `0`) * 100, 1))

#adjusted_quit <- predicted_quit %>%
  #group_by(REGION)%>%
  #summarize(`Adjusted Quit Rate` = round(mean(adjusted_quit_status) * 100, 1))%>%
  #select(`Adjusted Quit Rate`)

#tabe_final <- cbind(unadjusted_quit, adjusted_quit)
#kable(tabe_final, caption="Unadjusted and Adjusted Quit Rate by Region")


```

### Unadjusted and Adjusted Quit Rate for Quit smoking less than a year
```{r}
readjust_function(smoke_quit_lessthanyear, predicted_quit, REGION)
readjust_function(smoke_quit_lessthanyear, predicted_quit, binned_age)
readjust_function(smoke_quit_lessthanyear, predicted_quit, SEX)
readjust_function(smoke_quit_lessthanyear, predicted_quit, EDUC1)
readjust_function(smoke_quit_lessthanyear, predicted_quit, binned_RATCAT)
readjust_function(smoke_quit_lessthanyear, predicted_quit, mental_health_problem)
readjust_function(smoke_quit_lessthanyear, predicted_quit, RACERPI2)
readjust_function(smoke_quit_lessthanyear, predicted_quit, HOUSEOWN)
readjust_function(smoke_quit_lessthanyear, predicted_quit, INC_GRP)
readjust_function(smoke_quit_lessthanyear, predicted_quit, FOOD_SECURITY)
```

### Quit smoking for at least 6 months
```{r}

reg2_quit_6month_and_over <- quit_6month_and_over %>%
                          drop_na(REGION, any_of(vars))
# Quit smoke for at least a year or more
reg2 <- svyglm(formula = QUIT_STATUS ~ REGION + binned_age + SEX + EDUC1 + binned_RATCAT
               + ORIENT_A + mental_health_problem + RACERPI2 +HOUSEOWN + INC_GRP + FOOD_SECURITY, 
               design = quit_6month_and_over_design, 
               family = quasibinomial,
      data = quit_6month_and_over, na.action = na.omit)
summary(reg2)

# exponentiation of the coefficients to odds ratio with a 95 percent confidence interval
kable(exp(cbind(`Adjusted Odds Ratio` = coef(reg2), confint(reg2))), digits=3)

#fitting model to data
predicted_quit_least_6months <- reg2_quit_6month_and_over %>%
  mutate(
    adjusted_quit_status = predict(
      reg2,
      reg2_quit_6month_and_over,
      type = "response"
    )
  )
```


### Unadjusted and Adjusted Quit Rate for Quit smoking at least 6 months
```{r}
readjust_function(quit_6month_and_over, predicted_quit_least_6months, REGION)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, binned_age)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, SEX)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, EDUC1)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, binned_RATCAT)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, mental_health_problem)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, RACERPI2)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, HOUSEOWN)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, INC_GRP)
readjust_function(quit_6month_and_over, predicted_quit_least_6months, FOOD_SECURITY)
```


### Quit smoking for at least year and over
```{r}
reg3_quit_yearandover <- smoke_quit_yearandover %>%
                          drop_na(REGION, any_of(vars))
# Quit smoke for at least a year or more
reg3 <- svyglm(formula = QUIT_STATUS ~ REGION + binned_age + SEX + EDUC1 + binned_RATCAT
               + ORIENT_A + mental_health_problem + RACERPI2 +HOUSEOWN + INC_GRP + FOOD_SECURITY, 
               design = yearandover_design, 
               family = quasibinomial,
      data = smoke_quit_yearandover, na.action = na.omit)
summary(reg3)

# exponentiation of the coefficients to odds ratio with a 95 percent confidence interval
kable(exp(cbind(`Adjusted Odds Ratio` = coef(reg3), confint(reg3))), digits=3)

#fitting model to data
predicted_quit_yearandover <- reg3_quit_yearandover %>%
  mutate(
    adjusted_quit_status = predict(
      reg3,
      reg3_quit_yearandover,
      type = "response"
    )
  )

```


### Unadjusted and Adjusted Quit Rate for Quit smoking at least a year
```{r}
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, REGION)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, binned_age)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, SEX)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, EDUC1)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, binned_RATCAT)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, mental_health_problem)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, RACERPI2)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, HOUSEOWN)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, INC_GRP)
readjust_function(smoke_quit_yearandover, predicted_quit_yearandover, FOOD_SECURITY)
```



### attempt to quit smoking 
```{r}
reg4_attempt_to_quit <- attempt_to_quit %>%
                          drop_na(REGION, any_of(vars))
# Quit smoke for at least a year or more
reg4 <- svyglm(formula = CIGQTYR ~ REGION + binned_age + SEX + EDUC1 + binned_RATCAT
               + ORIENT_A + mental_health_problem + RACERPI2 +HOUSEOWN + INC_GRP + FOOD_SECURITY, 
               design = attempt_to_quit_design, 
               family = quasibinomial,
      data = attempt_to_quit, na.action = na.omit)
summary(reg4)

# exponentiation of the coefficients to odds ratio with a 95 percent confidence interval
kable(exp(cbind(`Adjusted Odds Ratio` = coef(reg4), confint(reg4))), digits=3)

#fitting model to data
predicted_attempt_to_quit <- reg4_attempt_to_quit %>%
  mutate(
    quit_attempt = predict(
      reg4,
      reg4_attempt_to_quit,
      type = "response"
    )
  )
```


### Unadjusted and Adjusted Attempt to Quit
```{r}
#rewriting readjust function for attempt to quit
attempt_readjust_function <- function(dframe1, dframe2, a_var, label){
  dframe1$CIGQTYR <- as.character(dframe1$CIGQTYR)
  dframe1 <- dframe1 %>%
    select({{a_var}}, CIGQTYR)
  dframe1 <- na.omit(dframe1)
  unadjusted_attempt <- dframe1%>%
    group_by({{a_var}}, CIGQTYR)%>%
    summarize(ATTEMPT_RATE = n())%>%
    spread(CIGQTYR, ATTEMPT_RATE)%>%
    transmute(`Unadjusted Attempt to Quit` = round((`1`)/(`1` + `0`) * 100, 1))

  adjusted_attempt <- dframe2 %>%
    group_by({{a_var}})%>%
    summarize(`Adjusted Attempt to Quit` = round(mean(quit_attempt) * 100, 1))%>%
    select(`Adjusted Attempt to Quit`)
  
  tabulate <- cbind(unadjusted_attempt, adjusted_attempt)
  kable(tabulate)
  
}
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, REGION)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, binned_age)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, SEX)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, EDUC1)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, binned_RATCAT)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, mental_health_problem)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, RACERPI2)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, HOUSEOWN)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, INC_GRP)
attempt_readjust_function(attempt_to_quit, predicted_attempt_to_quit, FOOD_SECURITY)
```